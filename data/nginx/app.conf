server {

    listen 80;
    listen [::]:80;
    server_name swinglab.app;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
      proxy_pass http://flask_wrapper:8080;
#        proxy_pass http://127.0.0.1:8080;

        # Do not change this
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_redirect off;

        return 301 https://$host$request_uri;
    }
    sendfile on;
    client_max_body_size 25M;
    access_log off;
}

server {
    listen 443 ssl;
    server_name swinglab.app;
    server_tokens off;

    ssl_certificate /etc/letsencrypt/live/swinglab.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/swinglab.app/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    location / {
         proxy_pass  http://flask_wrapper:8080;
#        proxy_pass  http://127.0.0.1:8080;
        proxy_set_header    Host                $http_host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;

        proxy_read_timeout  180;
        proxy_connect_timeout 180;
        proxy_send_timeout 180;
    }

#     location /dashboard {
#         proxy_read_timeout  180;
#         proxy_connect_timeout 180;
#         proxy_send_timeout 180;
#     }

#     location ~ .(jpg|mov|avi|mp4)$ {
#         valid_referers none blocked *.swinglab.app;
#         if ($invalid_referer) {
#             return 403;
#         }
#     }

    client_max_body_size 25M;
    sendfile on;
    access_log off;
}

# Only needed if you cache the plausible script. Speeds things up.
# Note: to use the `proxy_cache` setup, you'll need to make sure the `/var/run/nginx-cache`
# directory exists (e.g. creating it in a build step with `mkdir -p /var/run/nginx-cache`)
# To make `/var/run/nginx-cache` persist during reboots of your server
# make sure to run `echo "D /var/run/nginx-cache 0755 root root -" > /usr/lib/tmpfiles.d/nginx-cache.conf`
proxy_cache_path /var/run/nginx-cache/jscache levels=1:2 keys_zone=jscache:100m inactive=30d  use_temp_path=off max_size=100m;

server {

    resolver 9.9.9.9; # Use quad9 DNS resolver. Remove this line if you've already configured a DNS resolver.
    set $plausible_script_url https://plausible.io/js/script.js; # Change this if you use a different variant of the script
    set $plausible_event_url https://plausible.io/api/event;
    ...
    location = /js/script.js {
        proxy_pass $plausible_script_url;
        proxy_set_header Host plausible.io;


        # Tiny, negligible performance improvement. Very optional.
        proxy_buffering on;

        # Cache the script for 6 hours, as long as plausible.io returns a valid response
        proxy_cache jscache;
        proxy_cache_valid 200 6h;
        proxy_cache_use_stale updating error timeout invalid_header http_500;

        # Optional. Adds a header to tell if you got a cache hit or miss
        add_header X-Cache $upstream_cache_status;
    }

    location = /api/event {
        proxy_pass $plausible_event_url;
        proxy_set_header Host plausible.io;
        proxy_buffering on;
        proxy_http_version 1.1;

        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host  $host;
    }
}